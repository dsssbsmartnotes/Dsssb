<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DSSSB Super Admin ‚ö°</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root { --primary: #6366f1; --dark: #1e293b; --light: #f1f5f9; --success: #10b981; --danger: #ef4444; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { display: flex; height: 100vh; background: var(--light); color: var(--dark); overflow: hidden; }
    
    /* SIDEBAR */
    .sidebar { width: 250px; background: var(--dark); color: white; padding: 20px; display: flex; flex-direction: column; }
    .brand { font-size: 20px; font-weight: bold; margin-bottom: 40px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    .menu-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; opacity: 0.7; }
    .menu-item:hover, .menu-item.active { background: rgba(99, 102, 241, 0.1); color: var(--primary); opacity: 1; }
    
    /* MAIN CONTENT */
    .main { flex: 1; padding: 30px; overflow-y: auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
    .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .stat-val { font-size: 28px; font-weight: bold; margin-top: 5px; }
    .stat-label { font-size: 13px; color: #64748b; text-transform: uppercase; }

    /* TABLES & LISTS */
    .table-container { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
    th { background: #f8fafc; font-weight: 600; color: #64748b; }
    tr:hover { background: #f8fafc; }
    
    /* FORMS & INPUTS */
    .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    input, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; outline: none; }
    input:focus, select:focus { border-color: var(--primary); }
    button { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    button:hover { opacity: 0.9; }
    .btn-del { background: #fee2e2; color: var(--danger); padding: 5px 10px; border-radius: 5px; font-size: 12px; }

    /* SECTION CONTROL */
    .section { display: none; animation: fadeIn 0.3s; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* AUTH SCREEN */
    #authScreen { position: fixed; inset: 0; background: var(--dark); z-index: 1000; display: flex; justify-content: center; align-items: center; }
    .login-box { background: white; padding: 40px; border-radius: 20px; width: 350px; text-align: center; }
</style>
</head>
<body>

<div id="authScreen">
    <div class="login-box">
        <h2>üîí Admin Access</h2>
        <p style="color: grey; margin-bottom: 20px;">Enter security PIN to continue</p>
        <input type="password" id="adminPin" placeholder="Enter PIN (1234)" style="width: 100%; margin-bottom: 15px; text-align: center; letter-spacing: 5px; font-size: 20px;">
        <button onclick="checkPin()" style="width: 100%;">UNLOCK DASHBOARD</button>
    </div>
</div>

<div class="sidebar">
    <div class="brand"><i class="fas fa-shield-alt"></i> DSSSB Admin</div>
    <div class="menu-item active" onclick="showSec('dashboard', this)"><i class="fas fa-home"></i> Overview</div>
    <div class="menu-item" onclick="showSec('tests', this)"><i class="fas fa-book"></i> Manage Tests</div> <div class="menu-item" onclick="showSec('users', this)"><i class="fas fa-users"></i> Users & Pro</div>
    <div class="menu-item" onclick="showSec('results', this)"><i class="fas fa-poll"></i> Live Results</div>
</div>

<div class="main">
    
    <div id="dashboard" class="section active">
        <div class="header">
            <h2>üìä Dashboard Overview</h2>
            <button onclick="location.reload()"><i class="fas fa-sync"></i> Refresh Data</button>
        </div>
        <div class="stats-row">
            <div class="card" style="border-left: 5px solid var(--primary);">
                <div class="stat-label">Total Users</div>
                <div class="stat-val" id="statUsers">0</div>
            </div>
            <div class="card" style="border-left: 5px solid var(--success);">
                <div class="stat-label">Tests Attempted</div>
                <div class="stat-val" id="statTests">0</div>
            </div>
            <div class="card" style="border-left: 5px solid var(--danger);">
                <div class="stat-label">Pro Members</div>
                <div class="stat-val" id="statPro">0</div>
            </div>
            <div class="card" style="border-left: 5px solid orange;">
                <div class="stat-label">Total Tests Available</div>
                <div class="stat-val" id="statLibrary">0</div>
            </div>
        </div>
        <h3>Recent Activity</h3>
        <div class="table-container">
            <table>
                <thead><tr><th>Name</th><th>Test</th><th>Score</th><th>Time</th></tr></thead>
                <tbody id="recentTable"></tbody>
            </table>
        </div>
    </div>

    <div id="tests" class="section">
        <div class="header"><h2>üìö Manage Tests</h2></div>
        
        <div class="card" style="margin-bottom: 25px; border:1px solid #e2e8f0;">
            <h4 style="margin-bottom:15px; color:var(--primary);">‚ûï Add New Test</h4>
            <div class="form-grid">
                <input type="text" id="tTitle" placeholder="Test Title (e.g. Maths Mock 1)">
                <input type="text" id="tID" placeholder="Unique Test ID (e.g. TEST_005)">
                <input type="text" id="tUrl" placeholder="Link (e.g. quiz.html?id=TEST_005)">
                <input type="number" id="tTime" placeholder="Duration (Mins)">
                <input type="number" id="tQs" placeholder="Total Questions">
                <input type="number" id="tMarks" placeholder="Total Marks">
                <select id="tCat">
                    <option value="Full Mock">Full Mock</option>
                    <option value="Maths">Maths</option>
                    <option value="Reasoning">Reasoning</option>
                    <option value="English">English</option>
                    <option value="Hindi">Hindi</option>
                    <option value="GK">GK</option>
                    <option value="Computer">Computer</option>
                </select>
                <select id="tType">
                    <option value="free">Free</option>
                    <option value="pro">Pro Only</option>
                </select>
            </div>
            <button onclick="addTest()" style="width:100%;">Create Test</button>
        </div>

        <h3>Existing Tests</h3>
        <div class="table-container">
            <table>
                <thead><tr><th>Title</th><th>ID</th><th>Category</th><th>Type</th><th>Action</th></tr></thead>
                <tbody id="testTable"></tbody>
            </table>
        </div>
    </div>

    <div id="users" class="section">
        <div class="header"><h2>üë• Users & Pro Manager</h2></div>
        
        <div class="card" style="margin-bottom: 25px; background:linear-gradient(135deg, #fdfbf7, #fff7ed); border:1px solid #fed7aa;">
            <h4 style="color:#c2410c;">üëë Pro Membership Control</h4>
            <p style="color: grey; font-size: 13px; margin-bottom: 10px;">Enter Telegram Username (without @) OR User ID to Unlock Pro</p>
            <div class="input-group">
                <input type="text" id="newProInput" placeholder="e.g. amitkumar123 or 8837462">
                <button onclick="addProUser()" style="background:#ea580c;">Add Pro Member</button>
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="searchUser" placeholder="Search User by Name or ID..." onkeyup="searchTable('userTable', this.value)">
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Name</th><th>User ID</th><th>Tests Given</th><th>Action</th></tr></thead>
                <tbody id="userTable"></tbody>
            </table>
        </div>
    </div>

    <div id="results" class="section">
        <div class="header"><h2>üìù All Test Results</h2></div>
        <div class="input-group">
            <input type="text" id="searchRes" placeholder="Search Result..." onkeyup="searchTable('resTable', this.value)">
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Date</th><th>Student</th><th>Test ID</th><th>Score</th><th>Status</th></tr></thead>
                <tbody id="resTable"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
/* FIREBASE CONFIG */
const firebaseConfig = { apiKey: "AIzaSyDGolcXv0efZxRdOvBthfeT72mkNLLbAwI", authDomain: "dsssbexamportal.firebaseapp.com", databaseURL: "https://dsssbexamportal-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "dsssbexamportal", storageBucket: "dsssbexamportal.firebasestorage.app", messagingSenderId: "853373171134", appId: "1:853373171134:web:77b967374e6f34311af5ef" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* PIN LOCK */
function checkPin() {
    if(document.getElementById('adminPin').value === "1234") { 
        document.getElementById('authScreen').style.display = 'none';
        loadData();
    } else alert("Wrong PIN!");
}

/* NAVIGATION */
function showSec(id, el) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    el.classList.add('active');
}

/* DATA LOADING */
function loadData() {
    // 1. Fetch Users
    db.ref('users').on('value', snap => {
        const users = snap.val() || {};
        const tbody = document.getElementById('userTable');
        tbody.innerHTML = '';
        let count = 0;
        
        Object.entries(users).forEach(([key, u]) => {
            count++;
            let row = `<tr>
                <td><b>${u.name || 'Unknown'}</b></td>
                <td style="font-family:monospace; color:var(--primary);">${key}</td>
                <td><span style="background:#e0e7ff; color:#4338ca; padding:2px 8px; border-radius:4px; font-weight:bold;">${u.testsGiven || 0}</span></td>
                <td><button class="btn-del" onclick="deleteUser('${key}')"><i class="fas fa-trash"></i> Delete</button></td>
            </tr>`;
            tbody.innerHTML += row;
        });
        document.getElementById('statUsers').innerText = count;
    });

    // 2. Fetch Tests (NEW)
    db.ref('dsssb_tests_db').on('value', snap => {
        const tests = snap.val() || {};
        const tbody = document.getElementById('testTable');
        tbody.innerHTML = '';
        let count = 0;

        Object.entries(tests).forEach(([key, t]) => {
            count++;
            let row = `<tr>
                <td><b>${t.title}</b></td>
                <td>${t.id}</td>
                <td>${t.category}</td>
                <td>${t.type === 'pro' ? '<span style="color:orange;font-weight:bold">PRO</span>' : '<span style="color:green">FREE</span>'}</td>
                <td><button class="btn-del" onclick="deleteTest('${key}')"><i class="fas fa-trash"></i> Delete</button></td>
            </tr>`;
            tbody.innerHTML += row;
        });
        document.getElementById('statLibrary').innerText = count;
    });

    // 3. Fetch Pro Stats Only (List not shown here to save space)
    db.ref('dsssb_pro_users').on('value', snap => {
        document.getElementById('statPro').innerText = snap.numChildren();
    });

    // 4. Fetch Results
    db.ref('dsssb_results_live').limitToLast(100).on('value', snap => {
        const res = snap.val() || {};
        const tbody = document.getElementById('resTable');
        const recentBody = document.getElementById('recentTable');
        tbody.innerHTML = ''; recentBody.innerHTML = '';
        let totalTests = 0;
        let arr = Object.values(res).reverse(); 

        arr.forEach((r, i) => {
            totalTests++;
            const date = new Date(r.timestamp).toLocaleDateString();
            const time = Math.floor(r.timeTaken / 60) + 'm ' + (r.timeTaken % 60) + 's';
            let row = `<tr><td>${date}</td><td><b>${r.name}</b></td><td>${r.testId}</td><td><b>${r.score}</b></td><td>${time}</td></tr>`;
            tbody.innerHTML += row;
            if(i < 5) recentBody.innerHTML += row;
        });
        document.getElementById('statTests').innerText = totalTests;
    });
}

/* --- ACTIONS --- */

// Add Test
function addTest() {
    const data = {
        title: document.getElementById('tTitle').value,
        id: document.getElementById('tID').value,
        url: document.getElementById('tUrl').value,
        time: parseInt(document.getElementById('tTime').value),
        qs: parseInt(document.getElementById('tQs').value),
        marks: parseInt(document.getElementById('tMarks').value),
        category: document.getElementById('tCat').value,
        type: document.getElementById('tType').value
    };

    if(!data.title || !data.id || !data.url) return alert("Please fill details!");

    db.ref('dsssb_tests_db').push(data).then(() => {
        alert("Test Added Successfully!");
        // Clear inputs
        document.getElementById('tTitle').value = '';
    });
}

// Delete Test
function deleteTest(key) {
    if(confirm("Delete this test permanently?")) {
        db.ref('dsssb_tests_db/' + key).remove();
    }
}

// Delete User
function deleteUser(key) {
    if(confirm("Block/Delete this user? Data will be lost.")) {
        db.ref('users/' + key).remove();
    }
}

// Add Pro User
function addProUser() {
    const input = document.getElementById('newProInput');
    const val = input.value.trim().toLowerCase().replace('@','');
    if(!val) return alert("Enter Username/ID");
    db.ref('dsssb_pro_users').push(val).then(() => {
        input.value = ''; alert("Pro Member Added!");
    });
}

function searchTable(tableId, query) {
    const filter = query.toLowerCase();
    const rows = document.getElementById(tableId).getElementsByTagName('tr');
    for (let i = 0; i < rows.length; i++) {
        let text = rows[i].textContent || rows[i].innerText;
        rows[i].style.display = text.toLowerCase().indexOf(filter) > -1 ? "" : "none";
    }
}
</script>
</body>
</html>
