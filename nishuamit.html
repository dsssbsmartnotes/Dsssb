<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro Admin - Full Control</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
  * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
  body { background: #f1f5f9; margin: 0; padding: 0; color: #1e293b; }
  #loginOverlay { position: fixed; inset: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
  .login-box { background: white; padding: 40px; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 90%; max-width: 350px; }
  .login-box h2 { margin-top: 0; color: #4f46e5; }
  .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; outline: none; }
  .login-box button { width: 100%; background: #4f46e5; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
  #errorMsg { color: #ef4444; font-size: 13px; font-weight: bold; margin-top: 10px; display: none; }
  #adminContent { display: none; padding: 20px; max-width: 1200px; margin: auto; }
  .header { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #4f46e5, #9333ea); color: white; padding: 20px 25px; border-radius: 16px; margin-bottom: 20px; }
  .header h2 { margin: 0; font-size: 24px; }
  .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
  .tab-btn { padding: 12px 25px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: bold; color: #64748b; transition: 0.2s; }
  .tab-btn.active { background: #4f46e5; color: white; border-color: #4f46e5; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 5px; }
  .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; outline: none; }
  .btn-submit { background: #10b981; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 15px; margin-top: 10px; }
  table { width: 100%; border-collapse: collapse; min-width: 600px; }
  .table-container { overflow-x: auto; }
  th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
  th { background-color: #f8fafc; color: #475569; font-weight: 700; text-transform: uppercase; font-size: 13px; }
  .btn-del { background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; }
  .badge-free { background: #d1fae5; color: #059669; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 12px; }
  .badge-pro { background: #fef3c7; color: #d97706; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 12px; }
</style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2>üîí Admin Login</h2>
        <input type="password" id="adminPass" placeholder="Enter Password">
        <button onclick="checkAdmin()">LOGIN</button>
        <p id="errorMsg">Incorrect Password!</p>
    </div>
</div>

<div id="adminContent">
    <div class="header">
        <h2>DSSSB Pro Control Panel</h2>
        <button onclick="exportToCSV()" style="background:#10b981; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">üì• Export Results</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('results')">üìä Live Results</button>
        <button class="tab-btn" onclick="switchTab('tests')">üìù Manage Tests</button>
        <button class="tab-btn" onclick="switchTab('users')" style="background:#f59e0b; color:white; border:none;">üë• PRO Users List</button>
    </div>

    <div id="tab-results" class="tab-content active card">
        <h3>Student Leaderboard</h3>
        <div class="table-container">
            <table>
                <thead><tr><th>Rank</th><th>Name</th><th>Score</th><th>Correct</th><th>Wrong</th><th>Time</th></tr></thead>
                <tbody id="resultsTable"><tr><td colspan="6">Loading...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tab-tests" class="tab-content">
        <div class="card" style="max-width: 600px; margin: auto; margin-bottom: 30px;">
            <h3 style="margin-top:0; color:#4f46e5;">‚ûï Add New Mock Test</h3>
            <div class="form-group">
                <label>Test Type (Free or Pro)</label>
                <select id="t_type"><option value="free">üü¢ FREE Test</option><option value="pro">üëë PRO Test (Locked)</option></select>
            </div>
            <div class="form-group">
                <label>Test Title</label>
                <input type="text" id="t_title" placeholder="Enter Test Name">
            </div>
            <div style="display:flex; gap:15px;">
                <div class="form-group" style="flex:1;"><label>Questions</label><input type="number" id="t_qs"></div>
                <div class="form-group" style="flex:1;"><label>Duration (Mins)</label><input type="number" id="t_time"></div>
            </div>
            <div class="form-group">
                <label>HTML File Name</label>
                <input type="text" id="t_url" placeholder="Testv11.html">
            </div>
            <button class="btn-submit" onclick="addTest()">üöÄ PUBLISH TEST</button>
        </div>
        <div class="card">
            <h3>üìö Active Tests</h3>
            <div class="table-container">
                <table>
                    <thead><tr><th>ID</th><th>Type</th><th>Title</th><th>Link</th><th>Action</th></tr></thead>
                    <tbody id="testsTable"><tr><td colspan="5">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-users" class="tab-content">
        <div class="card" style="max-width: 600px; margin: auto; margin-bottom: 30px; border-top: 4px solid #f59e0b;">
            <h3 style="margin-top:0; color:#d97706;">üëë Give PRO Access to Student</h3>
            <p style="font-size: 13px; color: #64748b; margin-bottom:15px;">Enter the student's Telegram Username (e.g. amit_123) or Telegram User ID to unlock their tests.</p>
            <div class="form-group">
                <input type="text" id="pro_uid" placeholder="Enter Telegram Username or ID">
            </div>
            <button class="btn-submit" style="background:#f59e0b;" onclick="addProUser()">Grant Access ‚úÖ</button>
        </div>
        <div class="card">
            <h3>üë• Premium Members List</h3>
            <div class="table-container">
                <table>
                    <thead><tr><th>Telegram Username / ID</th><th>Access Status</th><th>Action</th></tr></thead>
                    <tbody id="proUsersTable"><tr><td colspan="3">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const ADMIN_PASS = "admin786";
const firebaseConfig = {
  apiKey: "AIzaSyDGolcXv0efZxRdOvBthfeT72mkNLLbAwI", authDomain: "dsssbexamportal.firebaseapp.com", databaseURL: "https://dsssbexamportal-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "dsssbexamportal", storageBucket: "dsssbexamportal.firebasestorage.app", messagingSenderId: "853373171134", appId: "1:853373171134:web:77b967374e6f34311af5ef"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let allData = [];

function checkAdmin() {
    if(document.getElementById('adminPass').value === ADMIN_PASS) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        fetchResults(); fetchTests(); fetchProUsers();
    } else { document.getElementById('errorMsg').style.display = 'block'; }
}

function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('tab-' + tabId).classList.add('active');
}

// RESULTS
function fetchResults() {
    db.ref("dsssb_results_live").on("value", (snap) => {
        let attempts = [];
        snap.forEach(child => { if(child.val().score !== undefined) attempts.push(child.val()); });
        attempts.sort((a, b) => b.score !== a.score ? b.score - a.score : a.timeTaken - b.timeTaken);
        allData = attempts;
        let html = "";
        attempts.forEach((row, i) => html += `<tr><td><b>#${i+1}</b></td><td>${row.name}</td><td><b style="color:#4f46e5">${row.score}</b></td><td>${row.correct||0}</td><td>${row.wrong||0}</td><td>${Math.floor(row.timeTaken/60)}m ${row.timeTaken%60}s</td></tr>`);
        document.getElementById('resultsTable').innerHTML = html || '<tr><td colspan="6">No results.</td></tr>';
    });
}
function exportToCSV() {
    if(allData.length === 0) return alert("No data!");
    let csv = "Rank,Name,Score,Correct,Wrong,Time\n";
    allData.forEach((r, i) => csv += `${i+1},${r.name.replace(/,/g,'')},${r.score},${r.correct||0},${r.wrong||0},${r.timeTaken}\n`);
    const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csv); link.download = "Results.csv"; link.click();
}

// TESTS
function fetchTests() {
    db.ref("dsssb_tests_db").on("value", (snap) => {
        let html = "";
        snap.forEach(child => {
            const t = child.val();
            let badge = t.type === 'pro' ? '<span class="badge-pro">üëë PRO</span>' : '<span class="badge-free">üü¢ FREE</span>';
            html += `<tr><td>${t.id}</td><td>${badge}</td><td><b>${t.title}</b></td><td>${t.url}</td><td><button class="btn-del" onclick="deleteTest('${t.id}')">Delete</button></td></tr>`;
        });
        document.getElementById('testsTable').innerHTML = html || '<tr><td colspan="5">No tests.</td></tr>';
    });
}
function addTest() {
    const type = document.getElementById('t_type').value, title = document.getElementById('t_title').value.trim(), qs = parseInt(document.getElementById('t_qs').value), time = parseInt(document.getElementById('t_time').value), url = document.getElementById('t_url').value.trim();
    if(!title || !url) return alert("Fill all fields!");
    const testId = "mock_" + Date.now(); 
    db.ref("dsssb_tests_db/" + testId).set({ id: testId, type: type, title: title, qs: qs, time: time, url: url, timestamp: firebase.database.ServerValue.TIMESTAMP })
      .then(() => { alert("‚úÖ Test Published!"); document.getElementById('t_title').value = ''; document.getElementById('t_url').value = ''; });
}
function deleteTest(id) { if(confirm("Delete this test?")) db.ref("dsssb_tests_db/" + id).remove(); }

// PRO USERS WHITELISTING
function fetchProUsers() {
    db.ref("dsssb_pro_users").on("value", (snap) => {
        let html = "";
        snap.forEach(child => {
            html += `<tr><td><b>${child.val().uid}</b></td><td><span class="badge-pro">Active</span></td><td><button class="btn-del" onclick="removeProUser('${child.key}')">Revoke Access</button></td></tr>`;
        });
        document.getElementById('proUsersTable').innerHTML = html || '<tr><td colspan="3">No Premium Users.</td></tr>';
    });
}
function addProUser() {
    let uid = document.getElementById('pro_uid').value.trim().replace('@', '').toLowerCase();
    if(!uid) return alert("Enter Username or ID");
    db.ref("dsssb_pro_users").push({ uid: uid, timestamp: firebase.database.ServerValue.TIMESTAMP })
      .then(() => { alert("‚úÖ Access Granted!"); document.getElementById('pro_uid').value = ''; });
}
function removeProUser(key) { if(confirm("Revoke premium access for this user?")) db.ref("dsssb_pro_users/" + key).remove(); }
</script>
</body>
</html>
