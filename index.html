<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DSSSB Pro - Smart Dashboard</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* =========================================
   TESTBOOK STYLE PREMIUM UI VARIABLES
   ========================================= */
:root {
  --tb-blue: #0266fd;
  --tb-dark-blue: #014bbd;
  --tb-light-blue: #eef5ff;
  --tb-green: #00b973;
  --tb-green-light: #e6f8f1;
  --tb-orange: #f59e0b;
  --tb-red: #ef4444;
  --text-main: #1e293b;
  --text-muted: #64748b;
  --bg-app: #f4f6f8;
  --card-bg: #ffffff;
  --border-light: #e2e8f0;
  --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.05);
  --shadow-blue: 0 8px 20px rgba(2, 102, 253, 0.2);
  --radius-lg: 16px;
  --radius-md: 10px;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: var(--bg-app); color: var(--text-main); padding-bottom: 30px; }

/* --- SECURITY LOADER --- */
#accessDenied { display: none; height: 100vh; width: 100vw; background: var(--bg-app); flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; z-index: 9999; position: fixed; inset: 0; }
.spinner-container { position: fixed; inset: 0; background: var(--bg-app); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.spinner { width: 45px; height: 45px; border: 4px solid var(--border-light); border-top: 4px solid var(--tb-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* --- HERO HEADER --- */
.hero-header { background: linear-gradient(135deg, var(--tb-blue), var(--tb-dark-blue)); padding: 25px 20px 60px; color: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; position: relative; }
.top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.brand { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 8px; letter-spacing: 0.5px; }
.pro-badge { background: linear-gradient(90deg, #f59e0b, #fbbf24); color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 2px 10px rgba(245,158,11,0.4); }
.user-greet { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
.user-sub { font-size: 13px; opacity: 0.85; }

/* --- OVERVIEW STATS (OVERLAPPING) --- */
.stats-wrapper { padding: 0 20px; margin-top: -40px; position: relative; z-index: 10; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.stat-box { background: var(--card-bg); padding: 18px; border-radius: var(--radius-lg); box-shadow: var(--shadow-card); display: flex; flex-direction: column; gap: 5px; border: 1px solid rgba(0,0,0,0.02); }
.stat-box .icon { width: 35px; height: 35px; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 18px; margin-bottom: 5px; }
.icon-rank { background: var(--tb-light-blue); color: var(--tb-blue); }
.icon-acc { background: var(--tb-green-light); color: var(--tb-green); }
.stat-val { font-size: 22px; font-weight: 800; color: var(--text-main); }
.stat-title { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }

/* --- SMART ANALYSIS SECTION --- */
.section-wrapper { padding: 25px 20px 0; }
.sec-title { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
.chart-card { background: var(--card-bg); padding: 20px; border-radius: var(--radius-lg); box-shadow: var(--shadow-card); margin-bottom: 20px; border: 1px solid var(--border-light); }
.comparison-bar { margin-top: 15px; }
.comp-label { display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; margin-bottom: 6px; color: var(--text-muted); }
.bar-bg { height: 8px; background: var(--border-light); border-radius: 10px; overflow: hidden; position: relative; margin-bottom: 10px; }
.bar-fill { height: 100%; border-radius: 10px; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
.fill-you { background: var(--tb-blue); }
.fill-topper { background: var(--tb-green); }

/* --- TEST CARDS --- */
.test-list { display: flex; flex-direction: column; gap: 15px; }
.test-card { background: var(--card-bg); border-radius: var(--radius-lg); padding: 20px; box-shadow: var(--shadow-card); border: 1px solid var(--border-light); display: flex; flex-direction: column; gap: 12px; transition: 0.2s; }
.test-card:active { transform: scale(0.98); }
.t-header { display: flex; justify-content: space-between; align-items: flex-start; }
.t-title { font-size: 16px; font-weight: 700; color: var(--text-main); }
.t-tags { display: flex; gap: 10px; margin-top: 8px; }
.tag { font-size: 11px; font-weight: 600; color: var(--text-muted); background: var(--bg-app); padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border-light); display: flex; align-items: center; gap: 4px; }

/* Results inside card */
.t-result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: var(--bg-app); padding: 12px; border-radius: var(--radius-md); margin-top: 5px; }
.res-item { display: flex; flex-direction: column; }
.res-item span:first-child { font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
.res-item span:last-child { font-size: 15px; color: var(--text-main); font-weight: 800; }

.t-actions { display: flex; gap: 10px; margin-top: 5px; }
.btn-primary { flex: 1; background: var(--tb-blue); color: #fff; border: none; padding: 12px; border-radius: var(--radius-md); font-size: 14px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px; box-shadow: var(--shadow-blue); }
.btn-outline { flex: 1; background: transparent; color: var(--tb-blue); border: 2px solid var(--tb-blue); padding: 12px; border-radius: var(--radius-md); font-size: 14px; font-weight: 700; cursor: pointer; }
</style>
</head>
<body>

<div id="accessDenied">
    <h1 style="font-size:50px; margin-bottom:10px;">üö´</h1>
    <h2 style="color:var(--tb-red)">Access Denied</h2>
    <p style="color:var(--text-muted); font-size:14px; margin-top:10px;">Please open your dashboard from the official Telegram Channel.</p>
</div>

<div id="loader" class="spinner-container">
    <div class="spinner"></div>
    <h3 style="color:var(--tb-blue); font-size:16px;">Loading Smart Analysis...</h3>
</div>

<div id="app" style="display: none;">
    <div class="hero-header">
        <div class="top-nav">
            <div class="brand">DSSSB Smart Notes</div>
            <div class="pro-badge">PRO PLAN</div>
        </div>
        <div class="user-greet">Hi, <span id="userName">Student</span></div>
        <div class="user-sub">Here is your AS/DASS Grade-II Progress</div>
    </div>

    <div class="stats-wrapper">
        <div class="stat-box">
            <div class="icon icon-rank">üèÜ</div>
            <div class="stat-val" id="myRank">--</div>
            <div class="stat-title">Global Rank</div>
        </div>
        <div class="stat-box">
            <div class="icon icon-acc">üéØ</div>
            <div class="stat-val" id="myAcc">0%</div>
            <div class="stat-title">Avg Accuracy</div>
        </div>
    </div>

    <div class="section-wrapper">
        <div class="sec-title">üìä Performance Analysis</div>
        <div class="chart-card">
            <div style="height: 180px; width: 100%;">
                <canvas id="performanceChart"></canvas>
            </div>
            
            <div style="margin-top: 20px; border-top: 1px dashed var(--border-light); padding-top: 15px;">
                <div class="comp-label">
                    <span><span style="color:var(--tb-blue);">‚óè</span> Your Avg Score</span>
                    <span id="txtYouScore">0</span>
                </div>
                <div class="bar-bg"><div class="bar-fill fill-you" id="barYouScore" style="width: 0%;"></div></div>
                
                <div class="comp-label" style="margin-top:12px;">
                    <span><span style="color:var(--tb-green);">‚óè</span> Topper Avg Score</span>
                    <span id="txtTopScore">0</span>
                </div>
                <div class="bar-bg"><div class="bar-fill fill-topper" id="barTopScore" style="width: 0%;"></div></div>
            </div>
        </div>
    </div>

    <div class="section-wrapper">
        <div class="sec-title" style="justify-content: space-between;">
            <span>üìù Mock Test Series</span>
            <span style="font-size:12px; color:var(--tb-blue); font-weight:700; background:var(--tb-light-blue); padding:4px 10px; border-radius:10px;" id="testCount">0 Tests</span>
        </div>
        <div class="test-list" id="testListContainer">
            </div>
    </div>
</div>
<script>
// ==========================================
// 1. FIREBASE CONFIGURATION
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyDGolcXv0efZxRdOvBthfeT72mkNLLbAwI",
  authDomain: "dsssbexamportal.firebaseapp.com",
  databaseURL: "https://dsssbexamportal-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dsssbexamportal",
  storageBucket: "dsssbexamportal.firebasestorage.app",
  messagingSenderId: "853373171134",
  appId: "1:853373171134:web:77b967374e6f34311af5ef"
};

if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db = firebase.database();
const DB_REF = "dsssb_results_live";

// ==========================================
// 2. MOCK TESTS DATABASE (Admin yahan tests add karenge)
// ==========================================
const TESTS_DB = [
    { id: "mock_01", title: "DSSSB Grade-II Full Mock 1", qs: 10, time: 120, url: "Testv11.html" },
    { id: "mock_02", title: "DSSSB Grade-II Full Mock 2", qs: 200, time: 120, url: "Test2.html" } // Future test
];

let userName = "Student";
let userAttempts = {};
let myScoreHistory = [];

// ==========================================
// 3. APP INIT & TELEGRAM SECURITY
// ==========================================
document.addEventListener("DOMContentLoaded", () => {
    const tg = window.Telegram.WebApp;
    tg.expand();

    if (!tg.initData) {
        // Agar browser me direct khola hai toh block
        document.getElementById('accessDenied').style.display = 'flex';
        document.getElementById('loader').style.display = 'none';
    } else {
        // Telegram se naam extract karna
        const user = tg.initDataUnsafe.user;
        if(user && user.first_name) {
            userName = user.first_name + (user.last_name ? " " + user.last_name : "");
            localStorage.setItem("dsssb_pro_user", userName); 
        }
        document.getElementById('userName').innerText = userName;
        fetchSmartData();
    }
});

// ==========================================
// 4. FETCH DATA & SMART ANALYSIS (Rank & Accuracy)
// ==========================================
async function fetchSmartData() {
    try {
        const snapshot = await db.ref(DB_REF).once("value");
        const data = snapshot.val();
        
        let allUsersData = {};
        
        if (data) {
            Object.values(data).forEach(att => {
                if(!att.name || att.score === undefined) return;
                
                // Sabhi users ka data group karna
                if(!allUsersData[att.name]) {
                    allUsersData[att.name] = { totalScore: 0, attempts: 0, highestScore: -999 };
                }
                
                allUsersData[att.name].totalScore += att.score;
                allUsersData[att.name].attempts += 1;
                if(att.score > allUsersData[att.name].highestScore) {
                    allUsersData[att.name].highestScore = att.score;
                }

                // Agar current user ka data hai, toh save karo
                if(att.name === userName) {
                    // Hum pehle test (mock_01) me existing data map kar rahe hain
                    if(!userAttempts["mock_01"] || att.score > userAttempts["mock_01"].score) {
                        userAttempts["mock_01"] = att;
                    }
                    myScoreHistory.push(att.score);
                }
            });
        }

        // Leaderboard Calculation
        let leaderboard = [];
        for (const [name, stats] of Object.entries(allUsersData)) {
            let avg = stats.totalScore / stats.attempts;
            leaderboard.push({ name: name, avgScore: avg });
        }

        // Topper nikalne ke liye sort karna
        leaderboard.sort((a, b) => b.avgScore - a.avgScore);

        let myRank = "--";
        let myAvg = 0;
        let topperAvg = leaderboard.length > 0 ? leaderboard[0].avgScore : 0;

        const myDataIndex = leaderboard.findIndex(u => u.name === userName);
        if(myDataIndex !== -1) {
            myRank = myDataIndex + 1; // 1-based indexing for Rank
            myAvg = leaderboard[myDataIndex].avgScore;
            
            // Overall Accuracy nikalna
            let myTotCorrect = 0, myTotWrong = 0;
            Object.values(data).forEach(att => {
                if(att.name === userName) {
                    myTotCorrect += (att.correct || 0);
                    myTotWrong += (att.wrong || 0);
                }
            });
            let totAtt = myTotCorrect + myTotWrong;
            let myAcc = totAtt > 0 ? ((myTotCorrect/totAtt)*100).toFixed(1) : 0;
            document.getElementById('myAcc').innerText = myAcc + "%";
        }

        document.getElementById('myRank').innerText = myRank !== "--" ? "#" + myRank : "--";
        
        // Comparison Bars (Aap vs Topper) Update Karna
        let maxBar = Math.max(myAvg, topperAvg, 10); // Scale factor
        let myPct = (myAvg / maxBar) * 100;
        let topPct = (topperAvg / maxBar) * 100;

        document.getElementById('txtYouScore').innerText = myAvg.toFixed(2);
        setTimeout(() => document.getElementById('barYouScore').style.width = myPct + "%", 500);
        
        document.getElementById('txtTopScore').innerText = topperAvg.toFixed(2);
        setTimeout(() => document.getElementById('barTopScore').style.width = topPct + "%", 500);

        // Chart aur Cards Render karna
        renderChart();
        renderTestCards();

        // Loader hide aur Asli Dashboard show
        document.getElementById('loader').style.display = 'none';
        document.getElementById('app').style.display = 'block';

    } catch(err) {
        console.error("Dashboard Error:", err);
        alert("Failed to sync data due to network error.");
    }
}

// ==========================================
// 5. CHART.JS GRAPH RENDERER
// ==========================================
function renderChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // User ke pichle kuch attempts ka data nikalna
    let labels = [];
    let dataPoints = [];
    
    if(myScoreHistory.length === 0) {
        labels = ['Test 1']; dataPoints = [0];
    } else {
        let recent = myScoreHistory.slice(-6); // Max 6 attempts
        recent.forEach((_, i) => labels.push('Attempt ' + (i+1)));
        dataPoints = recent;
    }

    // Graph ke niche gradient color
    let gradient = ctx.createLinearGradient(0, 0, 0, 180);
    gradient.addColorStop(0, 'rgba(2, 102, 253, 0.5)');
    gradient.addColorStop(1, 'rgba(2, 102, 253, 0.05)');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Your Score History',
                data: dataPoints,
                borderColor: '#0266fd',
                backgroundColor: gradient,
                borderWidth: 3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#0266fd',
                pointBorderWidth: 2,
                pointRadius: 5,
                fill: true,
                tension: 0.4 // Smooth curve look
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false }, ticks: { font: { family: "'Poppins', sans-serif", size: 10 } } },
                y: { grid: { borderDash: [4, 4], color: '#e2e8f0' }, beginAtZero: true, ticks: { font: { family: "'Poppins', sans-serif", size: 11 } } }
            }
        }
    });
}

// ==========================================
// 6. RENDER TESTS LIST (Cards)
// ==========================================
function renderTestCards() {
    const container = document.getElementById('testListContainer');
    document.getElementById('testCount').innerText = TESTS_DB.length + " Tests";
    let html = "";

    TESTS_DB.forEach((test, i) => {
        let attempt = userAttempts[test.id];
        let isDone = !!attempt;

        html += `<div class="test-card">
            <div class="t-header">
                <div class="t-title">${i+1}. ${test.title}</div>
                ${isDone ? '<span class="tag" style="color:var(--tb-green); border-color:var(--tb-green-light);"><span style="font-size:12px;">‚úÖ</span> Completed</span>' : '<span class="tag">üÜï New Test</span>'}
            </div>
            
            <div class="t-tags">
                <span class="tag">‚è± ${test.time} Mins</span>
                <span class="tag">üìù ${test.qs} Questions</span>
            </div>
        `;

        // Agar test de diya hai toh score dikhao
        if(isDone) {
            let acc = attempt.correct + attempt.wrong > 0 ? ((attempt.correct / (attempt.correct + attempt.wrong)) * 100).toFixed(1) : 0;
            html += `
            <div class="t-result-grid">
                <div class="res-item"><span>Highest Score</span><span style="color:var(--tb-blue);">${attempt.score.toFixed(2)}</span></div>
                <div class="res-item"><span>Accuracy</span><span>${acc}%</span></div>
            </div>
            <div class="t-actions">
                <button class="btn-outline" onclick="window.location.href='${test.url}'">Retake Test ‚Ü∫</button>
            </div>`;
        } else {
            // Agar nahi diya hai toh Start button dikhao
            html += `
            <div class="t-actions">
                <button class="btn-primary" onclick="window.location.href='${test.url}'">Start Exam ‚ûî</button>
            </div>`;
        }

        html += `</div>`;
    });

    container.innerHTML = html;
}
</script>
</body>
</html>

