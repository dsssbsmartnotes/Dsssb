<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DSSSB Smart Notes - Pro</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* --- THEME VARIABLES --- */
:root {
    --tb-blue: #0266fd; --tb-bg-blue: rgba(2, 102, 253, 0.08);
    --tb-green: #00b973; --tb-red: #ef4444;
    --text-main: #1e293b; --text-muted: #64748b;
    --bg-app: #f4f6f8; --card-bg: #ffffff;
    --border-light: #e2e8f0; --shadow-card: 0 4px 12px rgba(0,0,0,0.05);
    --nav-height: 65px;
}
body.dark-mode {
    --text-main: #f0f0f0; --text-muted: #a0a0a0;
    --bg-app: #181818; --card-bg: #242424; --border-light: #333333;
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: var(--bg-app); color: var(--text-main); padding-bottom: var(--nav-height); }

/* --- HEADER --- */
.hero-header { background: linear-gradient(135deg, var(--tb-blue), #014bbd); padding: 20px 20px 50px; color: white; border-radius: 0 0 30px 30px; position: relative; }
.top-nav { display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 18px; }
.pro-badge { background: linear-gradient(90deg, #f59e0b, #fbbf24); padding: 5px 12px; border-radius: 20px; font-size: 11px; color: white; box-shadow: 0 2px 8px rgba(245,158,11,0.4); }

/* --- TABS (PAGES) --- */
.tab-content { display: none; animation: fadeIn 0.3s; padding: 0 20px; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* --- CARDS & STATS --- */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: -35px; position: relative; z-index: 5; margin-bottom: 25px; }
.stat-card { background: var(--card-bg); padding: 15px; border-radius: 16px; box-shadow: var(--shadow-card); text-align: center; border: 1px solid var(--border-light); }
.stat-val { font-size: 20px; font-weight: 800; margin-top: 5px; }
.stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }

.section-title { font-size: 17px; font-weight: 800; margin: 20px 0 15px; display: flex; align-items: center; gap: 8px; }
.chart-container { background: var(--card-bg); padding: 15px; border-radius: 16px; border: 1px solid var(--border-light); box-shadow: var(--shadow-card); margin-bottom: 20px; }

/* --- TEST LIST --- */
.test-card { background: var(--card-bg); padding: 18px; border-radius: 16px; margin-bottom: 15px; border: 1px solid var(--border-light); box-shadow: var(--shadow-card); position: relative; overflow: hidden; }
.test-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--tb-blue); }
.t-head { display: flex; justify-content: space-between; margin-bottom: 8px; }
.t-title { font-weight: 700; font-size: 15px; }
.t-meta { display: flex; gap: 10px; font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
.btn-start { background: var(--tb-blue); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 700; width: 100%; cursor: pointer; }
.btn-locked { background: #f59e0b; color: white; }

/* --- BOTTOM NAV --- */
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: var(--card-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border-light); box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
.nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); font-size: 10px; font-weight: 600; width: 60px; cursor: pointer; transition: 0.2s; }
.nav-icon { font-size: 22px; margin-bottom: 4px; }
.nav-item.active { color: var(--tb-blue); }
.nav-item.active .nav-icon { transform: translateY(-2px); }

/* --- SKELETON & MODALS --- */
.skeleton { background: linear-gradient(90deg, var(--card-bg) 25%, var(--border-light) 50%, var(--card-bg) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 8px; height: 100px; margin-bottom: 15px; }
@keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
#loader { padding: 20px; }
</style>
</head>
<body>

<div id="loader">
    <div class="skeleton" style="height: 150px; border-radius: 0 0 20px 20px;"></div>
    <div class="skeleton" style="height: 80px; width: 48%; display:inline-block;"></div>
    <div class="skeleton" style="height: 80px; width: 48%; display:inline-block; margin-left:2%;"></div>
    <div class="skeleton" style="height: 200px;"></div>
</div>

<div id="app" style="display: none;">
    
    <div class="hero-header">
        <div class="top-nav">
            <span>DSSSB Portal</span>
            <span id="badgePro" class="pro-badge" style="display:none;">PRO USER</span>
        </div>
        <div style="margin-top: 15px;">
            <h1 style="font-size: 22px;">Hello, <span id="uName">Student</span></h1>
            <p style="opacity: 0.8; font-size: 13px;">Let's crack the exam today!</p>
        </div>
    </div>

    <div id="tab-home" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-val" id="valRank">--</div>
                <div class="stat-label">Global Rank</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-val" id="valTests">0</div>
                <div class="stat-label">Tests Taken</div>
            </div>
        </div>

        <div class="section-title">üöÄ Subject Performance</div>
        <div class="chart-container" style="position: relative; height: 250px;">
            <canvas id="radarChart"></canvas>
        </div>

        <div class="section-title">üìä Score Trends</div>
        <div class="chart-container" style="height: 180px;">
            <canvas id="lineChart"></canvas>
        </div>
    </div>

    <div id="tab-tests" class="tab-content" style="padding-top: 20px;">
        <h2 style="margin-bottom: 15px;">Mock Tests Library</h2>
        <div id="testList"></div>
    </div>

    <div id="tab-rank" class="tab-content" style="padding-top: 20px;">
        <h2 style="margin-bottom: 15px;">üèÜ Toppers List</h2>
        <div class="chart-container" id="leaderboardList">
            <p style="text-align:center; padding: 20px; color: var(--text-muted);">Loading Ranks...</p>
        </div>
    </div>

</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home', this)">
        <div class="nav-icon">üè†</div>
        <span>Home</span>
    </div>
    <div class="nav-item" onclick="switchTab('tests', this)">
        <div class="nav-icon">üìù</div>
        <span>Tests</span>
    </div>
    <div class="nav-item" onclick="switchTab('rank', this)">
        <div class="nav-icon">üìä</div>
        <span>Ranks</span>
    </div>
</div>

<script>
/* --- CONFIG --- */
const firebaseConfig = { apiKey: "AIzaSyDGolcXv0efZxRdOvBthfeT72mkNLLbAwI", authDomain: "dsssbexamportal.firebaseapp.com", databaseURL: "https://dsssbexamportal-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "dsssbexamportal", storageBucket: "dsssbexamportal.firebasestorage.app", messagingSenderId: "853373171134", appId: "1:853373171134:web:77b967374e6f34311af5ef" };
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = "Student";
let isPro = false;
let myScores = [];

/* --- INIT --- */
window.onload = function() {
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.expand();
        // Dark Mode Logic
        if(tg.colorScheme === 'dark') document.body.classList.add('dark-mode');
        
        if(tg.initDataUnsafe.user) {
            currentUser = tg.initDataUnsafe.user.first_name;
            document.getElementById('uName').innerText = currentUser;
            fetchData(tg.initDataUnsafe.user);
        } else {
            // Fallback for testing in browser
            fetchData({username: "test_user"}); 
        }
    } else {
        fetchData({username: "test_user"});
    }
};

/* --- TABS LOGIC --- */
function switchTab(tabId, el) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
}

/* --- DATA FETCH --- */
async function fetchData(user) {
    try {
        const [testsSnap, resultsSnap, proSnap] = await Promise.all([
            db.ref("dsssb_tests_db").once("value"),
            db.ref("dsssb_results_live").once("value"),
            db.ref("dsssb_pro_users").once("value")
        ]);

        // 1. Check Pro
        if(proSnap.exists()) {
            proSnap.forEach(c => { if(c.val().uid == user.id || c.val().uid == user.username) isPro = true; });
        }
        if(isPro) document.getElementById('badgePro').style.display = 'inline-block';

        // 2. Process Results
        const results = resultsSnap.val() || {};
        let userMap = {};
        let myTotalScore = 0;
        let myAttempts = 0;

        Object.values(results).forEach(r => {
            if(!userMap[r.name]) userMap[r.name] = { score: 0, count: 0 };
            userMap[r.name].score += r.score;
            userMap[r.name].count++;

            if(r.name === currentUser) {
                myScores.push(r.score);
                myAttempts++;
            }
        });

        // 3. Leaderboard Logic
        let leaderboard = Object.keys(userMap).map(k => ({ 
            name: k, avg: userMap[k].score / userMap[k].count 
        })).sort((a,b) => b.avg - a.avg);

        let myRank = leaderboard.findIndex(u => u.name === currentUser) + 1;
        document.getElementById('valRank').innerText = myRank > 0 ? `#${myRank}` : '--';
        document.getElementById('valTests').innerText = myAttempts;

        renderLeaderboard(leaderboard);
        renderCharts();

        // 4. Render Tests
        const tests = testsSnap.val() ? Object.values(testsSnap.val()) : [];
        renderTests(tests);

        document.getElementById('loader').style.display = 'none';
        document.getElementById('app').style.display = 'block';

    } catch(e) { console.error(e); }
}

/* --- UI RENDERERS --- */
function renderTests(tests) {
    let html = "";
    tests.forEach((t, i) => {
        let isLocked = t.type === 'pro' && !isPro;
        let btnColor = isLocked ? 'var(--tb-orange)' : 'var(--tb-blue)';
        let btnTxt = isLocked ? 'Unlock PRO üîí' : 'Start Test ‚ûî';
        let action = isLocked ? "window.open('https://t.me/DSSSBRank')" : `window.location.href='${t.url}'`;
        
        html += `
        <div class="test-card">
            <div class="t-head">
                <div class="t-title">${i+1}. ${t.title}</div>
                ${t.type==='pro' ? '<span style="font-size:10px;background:#fff3cd;padding:2px 6px;border-radius:4px;color:#d97706;">PRO</span>' : ''}
            </div>
            <div class="t-meta">
                <span>‚è± ${t.time}m</span> ‚Ä¢ <span>üìù ${t.qs} Qs</span> ‚Ä¢ <span>üéØ ${t.marks} Marks</span>
            </div>
            <button class="btn-start" style="background:${btnColor}" onclick="${action}">${btnTxt}</button>
        </div>`;
    });
    document.getElementById('testList').innerHTML = html || "<p>No tests found.</p>";
}

function renderLeaderboard(list) {
    let html = "";
    list.slice(0, 10).forEach((u, i) => {
        html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border-light);">
            <span><b>#${i+1}</b> ${u.name} ${u.name===currentUser?'(You)':''}</span>
            <span style="font-weight:bold; color:var(--tb-blue);">${u.avg.toFixed(1)}</span>
        </div>`;
    });
    document.getElementById('leaderboardList').innerHTML = html;
}

function renderCharts() {
    // 1. Radar Chart (Subject Strength - Mock Data for Visual)
    new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: ['Maths', 'English', 'Hindi', 'GK', 'Reasoning'],
            datasets: [{
                label: 'My Strength',
                data: [65, 80, 90, 55, 70], // Replace with real data logic later
                backgroundColor: 'rgba(2, 102, 253, 0.2)',
                borderColor: '#0266fd',
                pointBackgroundColor: '#0266fd'
            }]
        },
        options: {
            scales: { r: { suggestMin: 0, suggestMax: 100 } },
            plugins: { legend: { display: false } }
        }
    });

    // 2. Line Chart (Progress)
    new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
            labels: myScores.map((_, i) => `T${i+1}`),
            datasets: [{
                data: myScores,
                borderColor: '#00b973',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: { x: { display: false } }
        }
    });
}
</script>
</body>
</html>
