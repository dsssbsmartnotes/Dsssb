<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DSSSB Smart Notes - Pro Dashboard</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* --- THEME VARIABLES --- */
:root {
    --tb-blue: #0266fd; --tb-bg-blue: rgba(2, 102, 253, 0.1);
    --tb-green: #00b973; --tb-bg-green: rgba(0, 185, 115, 0.1);
    --tb-orange: #f59e0b; --tb-red: #ef4444;
    --text-main: #1e293b; --text-muted: #64748b;
    --bg-app: #f8fafc; --card-bg: #ffffff;
    --border-light: #e2e8f0; 
    --shadow-card: 0 4px 15px rgba(0,0,0,0.03);
    --nav-height: 70px;
}

body.dark-mode {
    --text-main: #f1f5f9; --text-muted: #94a3b8;
    --bg-app: #0f172a; --card-bg: #1e293b; 
    --border-light: #334155;
    --shadow-card: 0 4px 15px rgba(0,0,0,0.2);
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: var(--bg-app); color: var(--text-main); padding-bottom: var(--nav-height); transition: background 0.3s, color 0.3s; }

/* --- HEADER with Back Button --- */
.hero-header { 
    background: linear-gradient(135deg, var(--tb-blue), #0f5bd1); 
    padding: 25px 20px 50px; color: white; 
    border-radius: 0 0 35px 35px; position: relative; 
    box-shadow: 0 10px 20px rgba(2, 102, 253, 0.2);
    transition: all 0.3s ease;
}
.top-nav { display: flex; justify-content: space-between; align-items: center; }
.brand { font-weight: 800; font-size: 20px; letter-spacing: 0.5px; display:flex; align-items:center; gap:8px;}

/* Back Button */
.back-btn {
    background: rgba(255,255,255,0.2); border: none; color: white;
    width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
    display: none; place-items: center; font-size: 16px; margin-right: 10px;
}

.theme-switch { 
    background: rgba(255,255,255,0.2); border: none; color: white; 
    width: 36px; height: 36px; border-radius: 50%; cursor: pointer; 
    display: grid; place-items: center; font-size: 16px; transition: 0.2s;
}
.pro-badge { 
    background: linear-gradient(90deg, #fbbf24, #d97706); 
    padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; 
    color: white; box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4); text-transform: uppercase;
}

/* --- TABS --- */
.tab-content { display: none; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); padding: 0 20px; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

/* --- FILTERS (SCROLLABLE) --- */
.filter-container {
    display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px;
    scrollbar-width: none; -ms-overflow-style: none;
}
.filter-container::-webkit-scrollbar { display: none; }

.filter-btn {
    background: var(--card-bg); border: 1px solid var(--border-light);
    padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
    color: var(--text-muted); cursor: pointer; white-space: nowrap; transition: 0.2s;
    flex-shrink: 0;
}
.filter-btn.active {
    background: var(--tb-blue); color: white; border-color: var(--tb-blue);
    box-shadow: 0 4px 10px rgba(2, 102, 253, 0.3);
}

/* --- TESTS LIST --- */
.test-card { 
    background: var(--card-bg); padding: 20px; border-radius: 18px; margin-bottom: 15px; 
    border: 1px solid var(--border-light); box-shadow: var(--shadow-card); 
    position: relative; overflow: hidden; transition: transform 0.2s;
}
.test-card:active { transform: scale(0.98); }
.test-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: var(--tb-blue); }
.test-card.locked::before { background: var(--tb-orange); }

.t-head { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: flex-start; }
.t-title { font-weight: 700; font-size: 16px; line-height: 1.3; }
.t-tags { display: flex; gap: 5px; }
.tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 700; }
.tag-pro { background: #fffbeb; color: #d97706; border: 1px solid #fcd34d; }
.tag-new { background: #eff6ff; color: #3b82f6; border: 1px solid #bfdbfe; }
.t-meta { display: flex; gap: 15px; font-size: 13px; color: var(--text-muted); margin-bottom: 15px; font-weight: 500; }
.btn-start { 
    background: var(--tb-blue); color: white; border: none; padding: 12px; 
    border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; 
    display: flex; justify-content: center; align-items: center; gap: 8px; font-size: 14px;
}

/* --- STATS & CHARTS --- */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: -40px; position: relative; z-index: 5; margin-bottom: 25px; }
.stat-card { background: var(--card-bg); padding: 15px; border-radius: 18px; box-shadow: var(--shadow-card); text-align: center; border: 1px solid var(--border-light); }
.stat-val { font-size: 22px; font-weight: 800; margin-top: 2px; }
.stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }
.chart-container { background: var(--card-bg); padding: 15px; border-radius: 20px; border: 1px solid var(--border-light); box-shadow: var(--shadow-card); margin-bottom: 20px; }

/* --- BOTTOM NAV --- */
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: var(--card-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border-light); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
.nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); font-size: 11px; font-weight: 600; width: 70px; cursor: pointer; opacity: 0.7; }
.nav-icon { font-size: 20px; margin-bottom: 6px; }
.nav-item.active { color: var(--tb-blue); opacity: 1; transform: translateY(-2px); }

/* --- LEADERBOARD --- */
.rank-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-light); }
.rank-pos { width: 28px; height: 28px; background: var(--bg-app); border-radius: 50%; display: grid; place-items: center; font-weight: 700; font-size: 12px; color: var(--text-muted); }
.rank-pos.top-1 { background: #fef3c7; color: #d97706; }

/* --- LOADER --- */
#loader { padding: 20px; }
.skeleton { background: linear-gradient(90deg, var(--card-bg) 25%, var(--border-light) 50%, var(--card-bg) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 12px; height: 100px; margin-bottom: 15px; }
@keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
</style>
</head>
<body>

<div id="loader">
    <div class="skeleton" style="height: 160px; border-radius: 0 0 30px 30px;"></div>
    <div class="skeleton" style="height: 250px; margin: 20px;"></div>
</div>

<div id="app" style="display: none;">
    
    <div class="hero-header">
        <div class="top-nav">
            <div style="display:flex; align-items:center;">
                <button id="backBtn" class="back-btn" onclick="goHome()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="brand"><i class="fas fa-graduation-cap"></i> DSSSB Portal</div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span id="badgePro" class="pro-badge" style="display:none;">PRO</span>
                <button class="theme-switch" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <h1 style="font-size: 24px;">Hi, <span id="uName">Aspirant</span> üëã</h1>
            <p style="opacity: 0.85; font-size: 14px; margin-top: 5px;">Ready to beat your best score?</p>
        </div>
    </div>

    <div id="tab-home" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üèÜ</div><div class="stat-val" id="valRank">--</div><div class="stat-label">Global Rank</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üî•</div><div class="stat-val" id="valTests">0</div><div class="stat-label">Tests Given</div>
            </div>
        </div>
        <div class="chart-container" style="height: 260px;"><canvas id="radarChart"></canvas></div>
        <div class="chart-container" style="height: 200px;"><canvas id="lineChart"></canvas></div>
    </div>

    <div id="tab-tests" class="tab-content" style="padding-top: 20px;">
        <h2 style="margin-bottom: 20px;">üìö Mock Test Library</h2>
        
        <div class="filter-container">
            <button class="filter-btn active" onclick="filterTests('all', this)">All</button>
            <button class="filter-btn" onclick="filterTests('Full Mock', this)">Full Mock</button>
            <button class="filter-btn" onclick="filterTests('Reasoning', this)">Reasoning</button>
            <button class="filter-btn" onclick="filterTests('GK', this)">GK</button>
            <button class="filter-btn" onclick="filterTests('Maths', this)">Maths</button>
            <button class="filter-btn" onclick="filterTests('English', this)">English</button>
            <button class="filter-btn" onclick="filterTests('Hindi', this)">Hindi</button>
            <button class="filter-btn" onclick="filterTests('Computer', this)">Computer</button>
        </div>

        <div id="testList"></div>
    </div>

    <div id="tab-rank" class="tab-content" style="padding-top: 20px;">
        <h2 style="margin-bottom: 15px;">üèÜ Live Leaderboard</h2>
        <div class="chart-container" id="leaderboardList" style="padding: 0;"></div>
    </div>

</div>

<div class="bottom-nav">
    <div class="nav-item active" id="nav-home" onclick="switchTab('home')">
        <div class="nav-icon"><i class="fas fa-home"></i></div><span>Home</span>
    </div>
    <div class="nav-item" id="nav-tests" onclick="switchTab('tests')">
        <div class="nav-icon"><i class="fas fa-file-alt"></i></div><span>Tests</span>
    </div>
    <div class="nav-item" id="nav-rank" onclick="switchTab('rank')">
        <div class="nav-icon"><i class="fas fa-chart-line"></i></div><span>Ranks</span>
    </div>
</div>

<script>
/* CONFIG */
const firebaseConfig = { apiKey: "AIzaSyDGolcXv0efZxRdOvBthfeT72mkNLLbAwI", authDomain: "dsssbexamportal.firebaseapp.com", databaseURL: "https://dsssbexamportal-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "dsssbexamportal", storageBucket: "dsssbexamportal.firebasestorage.app", messagingSenderId: "853373171134", appId: "1:853373171134:web:77b967374e6f34311af5ef" };
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = "Student";
let isPro = false;
let myScores = [];
let allTestsData = []; 

window.onload = function() {
    const savedTheme = localStorage.getItem('theme');
    if(savedTheme === 'dark') document.body.classList.add('dark-mode');
    
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp; tg.expand();
        if(tg.colorScheme === 'dark' && !savedTheme) document.body.classList.add('dark-mode');
        
        if(tg.initDataUnsafe.user) {
            const u = tg.initDataUnsafe.user;
            currentUser = u.first_name + (u.last_name ? " " + u.last_name : "");
            document.getElementById('uName').innerText = currentUser;
            fetchData(u); // Pass Full Telegram Object
        } else {
            fetchData({username: "guest", id: "guest", first_name: "Guest"}); 
        }
    } else {
        fetchData({username: "guest", id: "guest", first_name: "Guest"});
    }
};

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
}

/* --- NAVIGATION --- */
function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('nav-' + tabId).classList.add('active');

    // Show Back Button everywhere except Home
    const backBtn = document.getElementById('backBtn');
    if(tabId === 'home') backBtn.style.display = 'none';
    else backBtn.style.display = 'grid';
}

function goHome() {
    switchTab('home');
}

/* --- MAIN LOGIC --- */
async function fetchData(user) {
    try {
        const [testsSnap, resultsSnap, proSnap, usersSnap] = await Promise.all([
            db.ref("dsssb_tests_db").once("value"),
            db.ref("dsssb_results_live").once("value"),
            db.ref("dsssb_pro_users").once("value"),
            db.ref("users").once("value")
        ]);

        // 1. PRO CHECK (ROBUST: ID, USERNAME, NAME)
        if(proSnap.exists()) {
            let tgUser = (user.username || "").toLowerCase().trim().replace("@", "");
            let tgId = (user.id || "").toString();
            let tgName = (user.first_name + (user.last_name ? " " + user.last_name : "")).toLowerCase().trim();

            proSnap.forEach(c => {
                let d = c.val();
                let dbVal = (typeof d === 'object' ? (d.username || d.id || d.uid || d.name || "") : d).toString();
                let cleanDbVal = dbVal.toLowerCase().trim().replace("@", "");
                
                if (cleanDbVal && (cleanDbVal === tgUser || cleanDbVal === tgId || cleanDbVal === tgName)) {
                    isPro = true;
                }
            });
        }
        if(isPro) {
            let badge = document.getElementById('badgePro');
            badge.style.display = 'inline-block';
            badge.innerText = "PRO MEMBER";
            badge.style.background = "linear-gradient(90deg, #10b981, #059669)";
        }

        // 2. STATS (UNIQUE ID + NAME FALLBACK)
        const results = resultsSnap.val() || {};
        let userMap = {}; 
        let myId = (user.id || "").toString();
        let calAttempts = 0;

        Object.values(results).forEach(r => {
            // Group by Name for Leaderboard
            if(!userMap[r.name]) userMap[r.name] = { s: 0, c: 0 };
            userMap[r.name].s += r.score; userMap[r.name].c++;

            // Check if it's ME (ID match or Name match fallback)
            let isMe = false;
            if (r.userId && r.userId.toString() === myId && myId !== 'guest') {
                isMe = true; 
            } else if (!r.userId && r.name === currentUser) {
                isMe = true; 
            }

            if(isMe) {
                myScores.push(r.score);
                calAttempts++;
            }
        });

        // 3. EXACT TEST COUNT
        let uData = usersSnap.val() || {};
        let finalCount = 0;
        
        // Try getting by ID
        if (myId !== 'guest' && uData[myId] && uData[myId].testsGiven) {
            finalCount = uData[myId].testsGiven;
        } else {
            // Fallback: Try Name
            let safeNameKey = currentUser.replace(/[^a-zA-Z0-9]/g, "_");
            if (uData[safeNameKey] && uData[safeNameKey].testsGiven) {
                finalCount = uData[safeNameKey].testsGiven;
            } else {
                finalCount = calAttempts;
            }
        }
        document.getElementById('valTests').innerText = finalCount;
        
        // 4. RANK
        let lb = Object.keys(userMap).map(k => ({ name: k, avg: userMap[k].s/userMap[k].c })).sort((a,b) => b.avg - a.avg);
        let myRank = lb.findIndex(u => u.name === currentUser) + 1;
        document.getElementById('valRank').innerText = myRank > 0 ? `#${myRank}` : '--';
        
        renderLeaderboard(lb);
        renderCharts();

        // 5. RENDER TESTS
        allTestsData = testsSnap.val() ? Object.values(testsSnap.val()) : [];
        filterTests('all', document.querySelector('.filter-btn.active')); 

        document.getElementById('loader').style.display = 'none';
        document.getElementById('app').style.display = 'block';

    } catch(e) { console.error(e); }
}

/* --- FILTER LOGIC --- */
function filterTests(category, btnElement) {
    if(btnElement) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
    }

    let filtered = [];
    if(category === 'all') {
        filtered = allTestsData;
    } else {
        filtered = allTestsData.filter(t => {
            let title = (t.title || "").toLowerCase();
            let cat = (t.category || "").toLowerCase();
            let key = category.toLowerCase();
            
            if(key === 'full mock') return title.includes('mock') || title.includes('full') || cat === 'full mock';
            if(key === 'reasoning') return title.includes('reas') || title.includes('logic') || cat.includes('reasoning');
            if(key === 'gk') return title.includes('gk') || title.includes('general') || cat.includes('gk');
            if(key === 'maths') return title.includes('math') || title.includes('quant') || cat.includes('math');
            if(key === 'english') return title.includes('eng') || title.includes('english') || cat.includes('english');
            if(key === 'hindi') return title.includes('hindi') || cat.includes('hindi');
            if(key === 'computer') return title.includes('comp') || title.includes('computer') || cat.includes('computer');
            return false;
        });
    }
    renderTests(filtered);
}

function renderTests(tests) {
    let html = "";
    tests.reverse().forEach((t) => {
        let isLocked = t.type === 'pro' && !isPro;
        // Fix for undefined marks
        let displayMarks = t.marks || t.qs || '20'; 

        let btnColor = isLocked ? 'var(--tb-orange)' : 'var(--tb-blue)';
        let btnTxt = isLocked ? '<i class="fas fa-lock"></i> PRO' : 'Start';
        let action = isLocked ? "window.open('https://t.me/Ak_india1')" : `window.location.href='${t.url}'`;

        html += `
        <div class="test-card ${isLocked ? 'locked' : ''}">
            <div class="t-head">
                <div class="t-title">${t.title}</div>
                <div class="t-tags">${t.type==='pro'?'<span class="tag tag-pro">PRO</span>':'<span class="tag tag-new">FREE</span>'}</div>
            </div>
            <div class="t-meta">
                <span><i class="far fa-clock"></i> ${t.time}m</span>
                <span><i class="far fa-file-alt"></i> ${t.qs} Qs</span>
                <span><i class="fas fa-bullseye"></i> ${displayMarks} Marks</span>
            </div>
            <button class="btn-start" style="background:${btnColor}" onclick="${action}">${btnTxt}</button>
        </div>`;
    });
    document.getElementById('testList').innerHTML = html || "<div style='text-align:center;padding:20px;color:grey'>No tests found in this category.</div>";
}

function renderLeaderboard(list) {
    let html = "";
    list.slice(0, 10).forEach((u, i) => {
        html += `<div class="rank-item">
            <div style="display:flex; gap:10px; align-items:center;">
                <div class="rank-pos ${i===0?'top-1':''}">${i+1}</div>
                <span>${u.name} ${u.name===currentUser?'<b style="color:var(--tb-blue)">(You)</b>':''}</span>
            </div>
            <b>${u.avg.toFixed(1)}</b>
        </div>`;
    });
    document.getElementById('leaderboardList').innerHTML = html;
}

function renderCharts() {
    new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: { labels: ['Math', 'Eng', 'Hin', 'GK', 'Reas'], datasets: [{ data: [65,80,90,55,75], backgroundColor: 'rgba(2,102,253,0.2)', borderColor: '#0266fd', borderWidth: 2 }] },
        options: { plugins: { legend: { display: false } }, scales: { r: { ticks: { display: false } } }, maintainAspectRatio: false }
    });
    new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: { labels: myScores.map((_, i) => `T${i+1}`), datasets: [{ data: myScores, borderColor: '#00b973', backgroundColor: 'rgba(0,185,115,0.1)', fill: true, tension: 0.4 }] },
        options: { plugins: { legend: { display: false } }, scales: { x: { display: false } }, maintainAspectRatio: false }
    });
}
</script>
</body>
</html>
